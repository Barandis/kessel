// Copyright (c) 2020 Thomas J. Otterson
//
// This software is released under the MIT License.
// https://opensource.org/licenses/MIT

import { all, anyString, str, strI } from 'kessel/parsers/string'
import { terror, tfail, tpass } from 'test/helper'

describe('String parsers', () => {
  describe('str', () => {
    it('throws if its first argument is not a string', () => {
      terror(str(0), '', '[str]: expected argument to be a string; found 0')
      terror(
        str(0, 'test'),
        '',
        '[str]: expected first argument to be a string; found 0',
      )
    })
    it('throws if its second argument exists and is not a string', () => {
      terror(
        str('test', 0),
        '',
        '[str]: expected second argument to be a string; found 0',
      )
    })
    it('fails at the end of input', () => {
      tfail(str('abc'), '', "'abc'")
      tfail(str('abc', 'test'), '', 'test')
    })

    context('1-byte characters', () => {
      const parser = str('Onoma')
      const parserm = str('Onoma', 'test')

      it('succeeds if the same number of characters is matched', () => {
        tpass(parser, 'Onomatopoeia', { result: 'Onoma', index: 5 })
        tpass(parserm, 'Onomatopoeia', { result: 'Onoma', index: 5 })
      })
      it('fails if case does not match', () => {
        tfail(parser, 'onomatopoeia', { expected: "'Onoma'", index: 0 })
        tfail(parserm, 'onomatopoeia', { expected: 'test', index: 0 })
      })
      it('does not consume input on failure', () => {
        tfail(parser, 'Onosho', { expected: "'Onoma'", index: 0 })
        tfail(parserm, 'Onosho', { expected: 'test', index: 0 })
      })
      it('fails if the string is longer than the remaining text', () => {
        tfail(parser, 'Ono', { expected: "'Onoma'", index: 0 })
        tfail(parserm, 'Ono', { expected: 'test', index: 0 })
      })
      it('succeeds with an empty string', () => {
        tpass(str(''), 'Onomatopoeia', { result: '', index: 0 })
        tpass(str('', 'test'), 'Onomatopoeia', { result: '', index: 0 })
      })
    })

    context('2-byte characters', () => {
      const parser = str('–ó–≤—É–∫–æ')
      const parserm = str('–ó–≤—É–∫–æ', 'test')

      it('succeeds if the same number of characters is matched', () => {
        tpass(parser, '–ó–≤—É–∫–æ–ø–æ–¥—Ä–∞–∂–∞–Ω–∏–µ', { result: '–ó–≤—É–∫–æ', index: 10 })
        tpass(parserm, '–ó–≤—É–∫–æ–ø–æ–¥—Ä–∞–∂–∞–Ω–∏–µ', { result: '–ó–≤—É–∫–æ', index: 10 })
      })
      it('fails if case does not match', () => {
        tfail(parser, '–∑–≤—É–∫–æ–ø–æ–¥—Ä–∞–∂–∞–Ω–∏–µ', { expected: "'–ó–≤—É–∫–æ'", index: 0 })
        tfail(parserm, '–∑–≤—É–∫–æ–ø–æ–¥—Ä–∞–∂–∞–Ω–∏–µ', { expected: 'test', index: 0 })
      })
      it('fails if the string is longer than the remaining text', () => {
        tfail(parser, '–ó–≤—É', { expected: "'–ó–≤—É–∫–æ'", index: 0 })
        tfail(parserm, '–ó–≤—É', { expected: 'test', index: 0 })
      })
      it('succeeds with an empty string', () => {
        tpass(str('', 'test'), '–ó–≤—É–∫–æ–ø–æ–¥—Ä–∞–∂–∞–Ω–∏–µ', { result: '', index: 0 })
      })
    })

    context('3-byte characters', () => {
      const parser = str('‡∏Ñ‡∏≥‡πÄ‡∏•‡∏µ')
      const parserm = str('‡∏Ñ‡∏≥‡πÄ‡∏•‡∏µ', 'test')

      it('succeeds if the same number of characters is matched', () => {
        tpass(parser, '‡∏Ñ‡∏≥‡πÄ‡∏•‡∏µ‡∏¢‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á', { result: '‡∏Ñ‡∏≥‡πÄ‡∏•‡∏µ', index: 15 })
        tpass(parserm, '‡∏Ñ‡∏≥‡πÄ‡∏•‡∏µ‡∏¢‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á', { result: '‡∏Ñ‡∏≥‡πÄ‡∏•‡∏µ', index: 15 })
      })
      it('fails if the string is longer than the remaining text', () => {
        tfail(parser, '‡∏Ñ‡∏≥‡πÄ', { expected: "'‡∏Ñ‡∏≥‡πÄ‡∏•‡∏µ'", index: 0 })
        tfail(parserm, '‡∏Ñ‡∏≥‡πÄ', { expected: 'test', index: 0 })
      })
      it('succeeds with an empty string', () => {
        tpass(str(''), '‡∏Ñ‡∏≥‡πÄ‡∏•‡∏µ‡∏¢‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á', { result: '', index: 0 })
        tpass(str('', 'test'), '‡∏Ñ‡∏≥‡πÄ‡∏•‡∏µ‡∏¢‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á', { result: '', index: 0 })
      })
    })

    context('4-byte characters', () => {
      const parser = str('ùëÇùëõùëúùëöùëé')
      const parserm = str('ùëÇùëõùëúùëöùëé', 'test')

      it('succeeds if the same number of characters is matched', () => {
        tpass(parser, 'ùëÇùëõùëúùëöùëéùë°ùëúùëùùëúùëíùëñùëé', { result: 'ùëÇùëõùëúùëöùëé', index: 20 })
        tpass(parserm, 'ùëÇùëõùëúùëöùëéùë°ùëúùëùùëúùëíùëñùëé', { result: 'ùëÇùëõùëúùëöùëé', index: 20 })
      })
      it('fails if the string is longer than the remaining text', () => {
        tfail(parser, 'ùëÇùëõùëú', { expect: "'ùëÇùëõùëúùëöùëé'", index: 0 })
        tfail(parser, 'ùëÇùëõùëú', { expect: 'test', index: 0 })
      })
      it('succeeds with an empty string', () => {
        tpass(str(''), 'ùëÇùëõùëúùëöùëéùë°ùëúùëùùëúùëíùëñùëé', { result: '', index: 0 })
        tpass(str('', 'test'), 'ùëÇùëõùëúùëöùëéùë°ùëúùëùùëúùëíùëñùëé', { result: '', index: 0 })
      })
    })
  })

  describe('strI', () => {
    it('throws if its argument is not a string', () => {
      terror(strI(0), '', '[strI]: expected argument to be a string; found 0')
      terror(
        strI(0, 'test'),
        '',
        '[strI]: expected first argument to be a string; found 0',
      )
    })
    it('throws if its second argument exists and is not a string', () => {
      terror(
        strI('test', 0),
        '',
        '[strI]: expected second argument to be a string; found 0',
      )
    })
    it('fails at the end of input', () => {
      tfail(strI('abc'), '', "'abc'")
      tfail(strI('abc', 'test'), '', 'test')
    })

    context('1-byte characters', () => {
      const parser = strI('Onoma')
      const parserm = strI('Onoma', 'test')

      it('succeeds if the same number of characters is matched', () => {
        tpass(parser, 'Onomatopoeia', { result: 'Onoma', index: 5 })
        tpass(parserm, 'Onomatopoeia', { result: 'Onoma', index: 5 })
      })
      it('succeeds if case does not match', () => {
        tpass(parser, 'onomatopoeia', { result: 'onoma', index: 5 })
        tpass(parserm, 'onomatopoeia', { result: 'onoma', index: 5 })
      })
      it('fails if the string is longer than the remaining text', () => {
        tfail(parser, 'Ono', { expected: "'Onoma'", index: 0 })
        tfail(parserm, 'Ono', { expected: 'test', index: 0 })
      })
      it('succeeds with an empty string', () => {
        tpass(str(''), 'Onomatopoeia', { result: '', index: 0 })
        tpass(str('', 'test'), 'Onomatopoeia', { result: '', index: 0 })
      })
    })

    context('2-byte characters', () => {
      const parser = strI('–ó–≤—É–∫–æ')
      const parserm = strI('–ó–≤—É–∫–æ', 'test')

      it('succeeds if the same number of characters is matched', () => {
        tpass(parser, '–ó–≤—É–∫–æ–ø–æ–¥—Ä–∞–∂–∞–Ω–∏–µ', { result: '–ó–≤—É–∫–æ', index: 10 })
        tpass(parserm, '–ó–≤—É–∫–æ–ø–æ–¥—Ä–∞–∂–∞–Ω–∏–µ', { result: '–ó–≤—É–∫–æ', index: 10 })
      })
      it('succeeds if case does not match', () => {
        tpass(parser, '–∑–≤—É–∫–æ–ø–æ–¥—Ä–∞–∂–∞–Ω–∏–µ', { result: '–∑–≤—É–∫–æ', index: 10 })
        tpass(parserm, '–∑–≤—É–∫–æ–ø–æ–¥—Ä–∞–∂–∞–Ω–∏–µ', { result: '–∑–≤—É–∫–æ', index: 10 })
      })
      it('fails if the string is longer than the remaining text', () => {
        tfail(parser, '–ó–≤—É', { expected: "'–ó–≤—É–∫–æ'", index: 0 })
        tfail(parserm, '–ó–≤—É', { expected: 'test', index: 0 })
      })
      it('succeeds with an empty string', () => {
        tpass(str(''), '–ó–≤—É–∫–æ–ø–æ–¥—Ä–∞–∂–∞–Ω–∏–µ', { result: '', index: 0 })
        tpass(str('', 'test'), '–ó–≤—É–∫–æ–ø–æ–¥—Ä–∞–∂–∞–Ω–∏–µ', { result: '', index: 0 })
      })
    })

    context('3-byte characters', () => {
      const parser = strI('‡∏Ñ‡∏≥‡πÄ‡∏•‡∏µ')
      const parserm = strI('‡∏Ñ‡∏≥‡πÄ‡∏•‡∏µ', 'test')

      it('succeeds if the same number of characters is matched', () => {
        tpass(parser, '‡∏Ñ‡∏≥‡πÄ‡∏•‡∏µ‡∏¢‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á', { result: '‡∏Ñ‡∏≥‡πÄ‡∏•‡∏µ', index: 15 })
        tpass(parserm, '‡∏Ñ‡∏≥‡πÄ‡∏•‡∏µ‡∏¢‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á', { result: '‡∏Ñ‡∏≥‡πÄ‡∏•‡∏µ', index: 15 })
      })
      it('fails if the string is longer than the remaining text', () => {
        tfail(parser, '‡∏Ñ‡∏≥‡πÄ', { expected: "'‡∏Ñ‡∏≥‡πÄ‡∏•‡∏µ'", index: 0 })
        tfail(parserm, '‡∏Ñ‡∏≥‡πÄ', { expected: 'test', index: 0 })
      })
      it('succeeds with an empty string', () => {
        tpass(str(''), '‡∏Ñ‡∏≥‡πÄ‡∏•‡∏µ‡∏¢‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á', { result: '', index: 0 })
        tpass(str('', 'test'), '‡∏Ñ‡∏≥‡πÄ‡∏•‡∏µ‡∏¢‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á', { result: '', index: 0 })
      })
    })

    context('4-byte characters', () => {
      const parser = strI('ùëÇùëõùëúùëöùëé')
      const parserm = strI('ùëÇùëõùëúùëöùëé', 'test')

      it('succeeds if the same number of characters is matched', () => {
        tpass(parser, 'ùëÇùëõùëúùëöùëéùë°ùëúùëùùëúùëíùëñùëé', { result: 'ùëÇùëõùëúùëöùëé', index: 20 })
        tpass(parserm, 'ùëÇùëõùëúùëöùëéùë°ùëúùëùùëúùëíùëñùëé', { result: 'ùëÇùëõùëúùëöùëé', index: 20 })
      })
      it('fails if the string is longer than the remaining text', () => {
        tfail(parser, 'ùëÇùëõùëú', { expected: "'ùëÇùëõùëúùëöùëé'", index: 0 })
        tfail(parserm, 'ùëÇùëõùëú', { expected: 'test', index: 0 })
      })
      it('succeeds with an empty string', () => {
        tpass(str(''), 'ùëÇùëõùëúùëöùëéùë°ùëúùëùùëúùëíùëñùëé', { result: '', index: 0 })
        tpass(str('', 'test'), 'ùëÇùëõùëúùëöùëéùë°ùëúùëùùëúùëíùëñùëé', { result: '', index: 0 })
      })
    })
  })

  describe('all', () => {
    it('results in all remaining 1-byte characters', () => {
      tpass(all, 'Onomatopoeia', { result: 'Onomatopoeia', index: 12 })
    })
    it('results in all remaining 2-byte characters', () => {
      tpass(all, '–ó–≤—É–∫–æ–ø–æ–¥—Ä–∞–∂–∞–Ω–∏–µ', { result: '–ó–≤—É–∫–æ–ø–æ–¥—Ä–∞–∂–∞–Ω–∏–µ', index: 30 })
    })
    it('results in all remaining 3-byte characters', () => {
      tpass(all, '‡∏Ñ‡∏≥‡πÄ‡∏•‡∏µ‡∏¢‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á', { result: '‡∏Ñ‡∏≥‡πÄ‡∏•‡∏µ‡∏¢‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á', index: 36 })
    })
    it('results in all remaining 4-byte characters', () => {
      tpass(all, 'ùëÇùëõùëúùëöùëéùë°ùëúùëùùëúùëíùëñùëé', { result: 'ùëÇùëõùëúùëöùëéùë°ùëúùëùùëúùëíùëñùëé', index: 48 })
    })
    it('succeeds at EOF', () => {
      tpass(all, '', { result: '', index: 0 })
    })
  })

  describe('anyString', () => {
    it('throws if its argument is not a number', () => {
      terror(anyString('0'), '', '[anyString]: expected a number; found "0"')
    })
    it('succeeds if there are more 1-byte characters than it reads', () => {
      tpass(anyString(5), 'Onomatopoeia', { result: 'Onoma', index: 5 })
    })
    it('succeeds if there are more 2-byte characters than it reads', () => {
      tpass(anyString(5), '–ó–≤—É–∫–æ–ø–æ–¥—Ä–∞–∂–∞–Ω–∏–µ', { result: '–ó–≤—É–∫–æ', index: 10 })
    })
    it('succeeds if there are more 3-byte characters than it reads', () => {
      tpass(anyString(5), '‡∏Ñ‡∏≥‡πÄ‡∏•‡∏µ‡∏¢‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á', { result: '‡∏Ñ‡∏≥‡πÄ‡∏•‡∏µ', index: 15 })
    })
    it('succeeds if there are more 4-byte characters than it reads', () => {
      tpass(anyString(5), 'ùëÇùëõùëúùëöùëéùë°ùëúùëùùëúùëíùëñùëé', { result: 'ùëÇùëõùëúùëöùëé', index: 20 })
    })
    it('fails if there aren\'t enough characters remaining', () => {
      tfail(anyString(5), 'Ono', {
        expected: 'a string of 5 characters',
        index: 0,
      })
    })
  })
})
